# This workflow is triggered for all scratch branches

name: Scratch Branches Workflow on Sim/CI Computer

# triggered whenever code is pushed to the scratch branches
on:
  push:
    branches: 
    - scratch/*

env:
  # Setup as a release build
  BUILD_TYPE: Release

jobs:
  Setup:
    # run on the simulation computer (self-hosted)
    runs-on: [self-hosted,ci-server,scratch-branch,X64]

    # checkout the repository along with submodules
    steps:
    - uses: actions/checkout@v2.3.1
      with:
        ref: ${{ github.head_ref }}
        submodules: 'recursive'

  Configure:
    runs-on: [self-hosted,ci-server,scratch-branch,X64]
    needs: Setup
    steps:
    - name: Configure CMake
    # create the build directory and run cmake
      run: |
        #remove the build directory if it exists already
        [ -d ${{github.workspace}}/build ] && rm -rf ${{github.workspace}}/build
        mkdir ${{github.workspace}}/build
        cd ${{github.workspace}}/build
        cmake -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} ..
        
  Build:
    runs-on: [self-hosted,ci-server,scratch-branch,X64]
    needs: Configure
    steps:        
    - name: Build
    # build the workspace
      working-directory: ${{github.workspace}}/build
      # Build your program with the given configuration
      run: make 

  Test:
    runs-on: [self-hosted,ci-server,scratch-branch,X64]
    needs: Build
    steps:
    - name: Test
      working-directory: ${{github.workspace}}/build
      # Execute tests defined by the CMake configuration.  
      # See https://cmake.org/cmake/help/latest/manual/ctest.1.html for more detail
      run: ctest -V -C ${{env.BUILD_TYPE}}
      
